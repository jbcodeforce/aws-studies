<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.5.3"><title>VPC- EC2 - AWS Studies</title><link rel=stylesheet href=../assets/stylesheets/main.7a952b86.min.css><link rel=stylesheet href=../assets/stylesheets/palette.cbb835fc.min.css><meta name=theme-color content=#2094f3><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#major-infrastructure-services class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="AWS Studies" class="md-header__button md-logo" aria-label="AWS Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> AWS Studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> VPC- EC2 </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/aws-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Introduction </a> </li> <li class=md-tabs__item> <a href=./ class="md-tabs__link md-tabs__link--active"> VPC- EC2 </a> </li> <li class=md-tabs__item> <a href=../gettingstarted/ class=md-tabs__link> Playground </a> </li> <li class=md-tabs__item> <a href=../well-architectured/ class=md-tabs__link> Well Architectured </a> </li> <li class=md-tabs__item> <a href=../sol-design/ class=md-tabs__link> Solution design </a> </li> <li class=md-tabs__item> <a href=../k8s/ class=md-tabs__link> Kubernetes services </a> </li> <li class=md-tabs__item> <a href=../psa-role/ class=md-tabs__link> SA </a> </li> <li class=md-tabs__item> <a href=https://jbcodeforce.github.io class=md-tabs__link> Return to main </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="AWS Studies" class="md-nav__button md-logo" aria-label="AWS Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> AWS Studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/aws-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> VPC- EC2 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> VPC- EC2 </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#ec2-components class=md-nav__link> EC2 components </a> <nav class=md-nav aria-label="EC2 components"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ec2-nitro class=md-nav__link> EC2 Nitro </a> </li> <li class=md-nav__item> <a href=#launch-types class=md-nav__link> Launch types </a> </li> <li class=md-nav__item> <a href=#ami class=md-nav__link> AMI </a> </li> <li class=md-nav__item> <a href=#ec2-hibernate class=md-nav__link> EC2 Hibernate </a> </li> <li class=md-nav__item> <a href=#basic-fault-tolerance class=md-nav__link> Basic Fault Tolerance </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#vpc class=md-nav__link> VPC </a> </li> <li class=md-nav__item> <a href=#security-group class=md-nav__link> Security group </a> </li> <li class=md-nav__item> <a href=#networking class=md-nav__link> Networking </a> <nav class=md-nav aria-label=Networking> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playing-with-apache-http class=md-nav__link> Playing with Apache HTTP </a> </li> <li class=md-nav__item> <a href=#elastic-network-insterfaces class=md-nav__link> Elastic Network Insterfaces </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#placement-groups class=md-nav__link> Placement groups </a> </li> <li class=md-nav__item> <a href=#elastic-load-balancer class=md-nav__link> Elastic Load balancer </a> <nav class=md-nav aria-label="Elastic Load balancer"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#load-balancer-stickiness class=md-nav__link> Load balancer stickiness </a> </li> <li class=md-nav__item> <a href=#cross-zone-load-balancing class=md-nav__link> Cross Zone Load Balancing </a> </li> <li class=md-nav__item> <a href=#tls-transport-layer-security class=md-nav__link> TLS - Transport Layer Security, </a> </li> <li class=md-nav__item> <a href=#connection-draining class=md-nav__link> Connection draining </a> </li> <li class=md-nav__item> <a href=#auto-scaling-group-asg class=md-nav__link> Auto Scaling Group (ASG) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../gettingstarted/ class=md-nav__link> Playground </a> </li> <li class=md-nav__item> <a href=../well-architectured/ class=md-nav__link> Well Architectured </a> </li> <li class=md-nav__item> <a href=../sol-design/ class=md-nav__link> Solution design </a> </li> <li class=md-nav__item> <a href=../k8s/ class=md-nav__link> Kubernetes services </a> </li> <li class=md-nav__item> <a href=../psa-role/ class=md-nav__link> SA </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io class=md-nav__link> Return to main </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#ec2-components class=md-nav__link> EC2 components </a> <nav class=md-nav aria-label="EC2 components"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ec2-nitro class=md-nav__link> EC2 Nitro </a> </li> <li class=md-nav__item> <a href=#launch-types class=md-nav__link> Launch types </a> </li> <li class=md-nav__item> <a href=#ami class=md-nav__link> AMI </a> </li> <li class=md-nav__item> <a href=#ec2-hibernate class=md-nav__link> EC2 Hibernate </a> </li> <li class=md-nav__item> <a href=#basic-fault-tolerance class=md-nav__link> Basic Fault Tolerance </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#vpc class=md-nav__link> VPC </a> </li> <li class=md-nav__item> <a href=#security-group class=md-nav__link> Security group </a> </li> <li class=md-nav__item> <a href=#networking class=md-nav__link> Networking </a> <nav class=md-nav aria-label=Networking> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playing-with-apache-http class=md-nav__link> Playing with Apache HTTP </a> </li> <li class=md-nav__item> <a href=#elastic-network-insterfaces class=md-nav__link> Elastic Network Insterfaces </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#placement-groups class=md-nav__link> Placement groups </a> </li> <li class=md-nav__item> <a href=#elastic-load-balancer class=md-nav__link> Elastic Load balancer </a> <nav class=md-nav aria-label="Elastic Load balancer"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#load-balancer-stickiness class=md-nav__link> Load balancer stickiness </a> </li> <li class=md-nav__item> <a href=#cross-zone-load-balancing class=md-nav__link> Cross Zone Load Balancing </a> </li> <li class=md-nav__item> <a href=#tls-transport-layer-security class=md-nav__link> TLS - Transport Layer Security, </a> </li> <li class=md-nav__item> <a href=#connection-draining class=md-nav__link> Connection draining </a> </li> <li class=md-nav__item> <a href=#auto-scaling-group-asg class=md-nav__link> Auto Scaling Group (ASG) </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/jbcodeforce/aws-studies.git/edit/master/docs/infra/index.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=major-infrastructure-services>Major infrastructure services<a class=headerlink href=#major-infrastructure-services title="Permanent link">&para;</a></h1> <h2 id=ec2-components>EC2 components<a class=headerlink href=#ec2-components title="Permanent link">&para;</a></h2> <ul> <li>EC2 is a renting machine</li> <li>Storing data on virtual drives: <a href=#EBS>EBS</a></li> <li>Distribute load across machines using ELB</li> <li>Auto scale the service via group: ASG</li> </ul> <p>EC2 can have MacOS, Linux ad Windows OS. Amazon Machine Image: AMI, image for OS and preinstalled softwares. Amazon Linux 2 for linux base image.</p> <p><img alt=0 src=images/EC2-instance.png></p> <p>When creating an instance, we can select the OS, CPU, RAM, the VPC, the AZ subnet, and the storage (EBS) for root folder to get the OS, the network card, and the firewall rules as security group. The security group helps to isolate the instance, for example, authorizing ssh on port 22 and HTTP port 80. Get the public ssh key, and when the instance is started, use: <code>ssh -i EC2key.pem ec2-user@ec2-52-8-75-8.us-west-1.compute.amazonaws.com</code> to connect to the EC2. The <code>.pem</code> file need to be restricted with <code>chmod 0400</code></p> <p>Can also use <strong>EC2 Instance Connect</strong> to open a terminal in the web browser. Still needs to get SSH port open.</p> <p>EC2 has a section to add <code>User data</code>, which could be used to define a bash script to install dependent software and to start some services at boot time.</p> <p>EC2 <strong>instance types</strong> (see <a href=https://www.ec2instances.info>ec2instances.info</a> or the reference <a href=https://aws.amazon.com/ec2/instance-types/ >aws ec2/instance-types</a>) includes:</p> <ul> <li>R: (memory) applications that needs a lot of RAM – in-memory caches</li> <li>C: (Compute Optimized) applications that needs good CPU – compute / databases, ETLm media transcoding, High Perf web servers, scientific modeling</li> <li>M: applications that are balanced (think “medium”) – general / web app</li> <li>I: (storage) applications that need good local I/O (instance storage) – databases, NoSQL, cache like Redis, data warehousing, distributed file systems</li> <li>G: applications that need a GPU</li> <li>T2/T3 for burstable instance: When the machine needs to process something unexpected (a spike in load for example), it can burst. Use burst credits to control CPU usage.</li> </ul> <h3 id=ec2-nitro>EC2 Nitro<a class=headerlink href=#ec2-nitro title="Permanent link">&para;</a></h3> <p>Next generation of EC2. It uses new virtualization schema. Supports IPv6, better I/O on EBS and better security. Name starts with C5, D5,...</p> <p>vCPU represents thread running on core CPU. You can optimize vCPU allocation on the EC2 instance, once created, by updating the launch configuration.</p> <h3 id=launch-types>Launch types<a class=headerlink href=#launch-types title="Permanent link">&para;</a></h3> <ul> <li><strong>On demand</strong>: short workload, predictable pricing, pay per second after first minute.</li> <li><strong>Reserved</strong> for one or 3 years, used for long workloads like database. Get discounted rate from on-demand.</li> <li><strong>Convertible reserved</strong> instance for changing resource capacity over time.</li> <li><strong>Scheduled reserved</strong> instance for job based workload.</li> <li> <p><strong>Spot instance</strong> for very short - 90% discount on on-demand - used for work resilient to failure like batch job, data analysis, image processing,...</p> <ul> <li>Define a <strong>max spot price</strong> and get the instance while the current spot price &lt; max. The hourly spot price varies based on offer and capacity. </li> <li>if the current spot price &gt; max, then instance will be stopped</li> <li>with spot block we can define a time frame without interruptions.</li> <li>The expected state is defined in a 'spot request' which can be cancelled. One time or persistent request types are supported. Cancel a spot request does not terminate instances, but need to be the first thing to do and then terminate the instances.</li> <li>Spot fleets allow to automatically request spot instance with the lowest price.</li> </ul> </li> <li> <p><strong>Dedicated hosts</strong> to book entire physical server and control instance placement. # years. BYOL. </p> </li> </ul> <p>Use <strong>EC2 launch templates</strong> to automate instance launches, simplify permission policies, and enforce best practices across the organization. (Look very similar to docker image)</p> <h3 id=ami>AMI<a class=headerlink href=#ami title="Permanent link">&para;</a></h3> <p>Bring our own image. Shareable on amazon marketplace. Can be saved on S3 storage. By default, our AMIs are private, and locked for our account / region.</p> <p>AMI are built for a specific AWS region. But they can be copied and shared <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/CopyingAMIs.html>See AWS doc - copying an AMI</a>.</p> <h3 id=ec2-hibernate>EC2 Hibernate<a class=headerlink href=#ec2-hibernate title="Permanent link">&para;</a></h3> <p>The in memory state is preserved, persisted to a file in the root EBS volume. It helps to make the instance startup time quicker. The root EBS volume is encrypted. Constrained by 150GB RAM. No more than 60 days.</p> <h3 id=basic-fault-tolerance>Basic Fault Tolerance<a class=headerlink href=#basic-fault-tolerance title="Permanent link">&para;</a></h3> <p>The following diagram illustrates some fault tolerance principles offered by the basic AWS services:</p> <p><img alt src=diagrams/ec2-fault-tolerance.drawio.svg></p> <ul> <li>AMI defines image for the EC2 with static or dynamic configuration. From one AMI, we can scale by adding new EC2 based on same image.</li> <li>Instance failure can be replaced by starting a new instance from the same AMI</li> <li>Auto scaling group defines a set of EC2 instances, and can start new EC2 instance automatically</li> <li>To minimize down time, we can have one EC2 instance in standby, and use elastic IP addresses. </li> <li>Data is saved on EBS and replicated to other EBS inside the same availabiltiy zone.</li> <li>Snapshot backup can be done to replicate data between AZs, and persisted for long retention in S3. </li> <li>Need to flush data from memory to disk before any snapshot</li> <li>Auto scaling adjusts the capacity of EC2 and EC2 instance within the group</li> <li>Applications can be deployed between AZs.</li> <li>Elastic Load Balancer balances traffic among servers in multiple AZs and DNS will route traffic to the good server.</li> <li>Data can be replicated between regions</li> <li>Elastic IP addresses are static and defined at the AWS account level. New EC2 instance can be reallocated to Elastic IP @, but they are mapped by internet gateway to the private address of the EC2. The service may be down until new EC2 instace is restarted.</li> <li>ELB ensures higher fault tolerance for EC2s, containers, lambdas, IP addresses and physical servers</li> <li>Application LB load balances at the HTTP, HTTPS level, and within a VPC based on the content of the request.</li> <li>NLB is for TCP, UDP, TLS routing and load balancing. </li> </ul> <h2 id=vpc>VPC<a class=headerlink href=#vpc title="Permanent link">&para;</a></h2> <p>A virtual private cloud (VPC) is a virtual network dedicated to your AWS account. It is logically isolated from other virtual networks in the AWS Cloud. You can launch your AWS resources, such as Amazon EC2 instances, into your VPC. You can specify an IP address range for the VPC, add subnets, associate security groups, and configure route tables.</p> <p>VPC Helps to:</p> <ul> <li>Assign static IP addresses, potentially multiple addresses for the same instance</li> <li>Change security group membership for your instances while they're running</li> <li>Control the outbound traffic from your instances (egress filtering) in addition to controlling the inbound traffic to them (ingress filtering)</li> <li>Default VPC includes an internet gateway </li> </ul> <p>The following diagram illustrates classical VPC, as defined years ago, with one vpc, 2 availability zones, 2 subnets with EC2 instances within those subnet and AZs.</p> <p><img alt src=images/vpc.png width=600></p> <ul> <li>non-default subnet has a private IPv4 address, but no public IPv4 </li> </ul> <p>You can enable internet access for an EC2 instance launched into a non-default subnet by attaching an internet gateway to its VPC. </p> <p>Route tables defines <code>172.3</code> as local with <code>/20</code> CIDR address range, internal to the VPC. Default route to internet goes to the IGW, which has an elastic IP address assigned to it. Because the VPC is cross AZs, we need a router to route between subnets. (See <a href=../architecture/tcpip.md>TCP/IP summary</a>)</p> <p>Alternatively, to allow an instance in your VPC to initiate outbound connections to the internet but prevent unsolicited inbound connections from the internet, you can use a network address translation (NAT) service for IPv4 traffic. NAT maps multiple private IPv4 addresses to a single public IPv4 address. </p> <p>A NAT device has an Elastic IP address and is connected to the internet through an internet gateway. </p> <p><img alt src=images/vpc-anim.gif></p> <p><strong> figure: Full VPC diagram</strong></p> <p>You can have <a href>VPC end point service</a> to access a <a href=https://docs.aws.amazon.com/vpc/latest/privatelink/aws-services-privatelink-support.html>lot of AWS services</a>, like S3, privately as those services will be in your VPC. TCP traffic is isolated. It is part of a larger offering called <a href=https://docs.aws.amazon.com/vpc/latest/privatelink/what-is-privatelink.html>AWS PrivateLink</a> establishes private connectivity between VPCs and services hosted on AWS or on-premises, without exposing data to the internet (No internet gateway, no NAT, no public IP @).</p> <p>You can optionally connect your VPC to your own corporate data center using an IPsec AWS managed VPN connection, making the AWS Cloud an extension of your data center. A VPN connection consists of a virtual private gateway (VGW) attached to your VPC and a customer gateway located in your data center. A virtual private gateway is the VPN concentrator on the Amazon side of the VPN connection. A customer gateway is a physical device or software appliance on your side of the VPN connection.</p> <p><img alt src=images/vpc-vpn.png></p> <p>As seen in "Full VPC diagram", the <code>VPC peering</code> helps to connect between VPCs in different region, or within the same region. And <a href=https://docs.aws.amazon.com/vpc/latest/tgw/what-is-transit-gateway.html>Transit GTW</a> is used to interconnect your virtual private clouds (VPCs) and on-premises networks</p> <h2 id=security-group>Security group<a class=headerlink href=#security-group title="Permanent link">&para;</a></h2> <p>Define inbound and outbound security rules. They regulate access to ports, authorized IP ranges IPv4 and IPv6, control inbound and outbound network. By default all inbound traffic is denied and outbound authorized.</p> <ul> <li>They contain <code>allow rules</code> only.</li> <li>Can be attached to multiple EC2 instances and to load balancers</li> <li>Locked down to a region / VPC combination</li> <li>Live outside of the EC2</li> <li>Define one separate security group for SSH access where you can authorize only one IP@</li> <li>Connect refused is an application error or the app is not launched</li> <li>Instances with the same security group can access each other</li> <li>Security group can reference other security groups, IP address, CIDR but no DNS server</li> </ul> <p><img alt=2 src=images/security-group.png></p> <p>Important Ports:</p> <ul> <li>22 for SSH and SFTP</li> <li>21 for FTP</li> <li>80 for HTTP</li> <li>443 for https</li> <li>3389: Remote desktop protocol</li> </ul> <h2 id=networking>Networking<a class=headerlink href=#networking title="Permanent link">&para;</a></h2> <p>IPv4 allows 3.7 billions of different addresses. Private IP @ is for private network connections. Internet gateway has public and private connections. Public IP can be geo-located. When connected to an EC2 the prompt lists the private IP (<code>ec2-user@ip-172-31-18-48</code>). Private IP stays stable on instance restart, while public may change.</p> <p>With Elastic IP address, we can mask an EC2 instance failure by rapidly remapping the address to another instance. But better to use DNS. Elastic IP is a public IPv4 that you own as long as you want and you can attach it to one EC2 instance at a time.</p> <h3 id=playing-with-apache-http>Playing with Apache HTTP<a class=headerlink href=#playing-with-apache-http title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># Swap to root</span>
sudo su
<span class=c1># update OS</span>
yum update -y
<span class=c1># Get Apache HTTPd</span>
yum install -y httpd.x86_64
<span class=c1># Start the service</span>
systemctl start httpd.service
<span class=c1># Enable it cross restart</span>
systemctl <span class=nb>enable</span> httpd.service
&gt; Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service
<span class=c1># Get the availability zone</span>
EC2-AZ<span class=o>=</span><span class=k>$(</span>curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone<span class=k>)</span>
<span class=c1># Change the home page by changing /var/www/html/index.html</span>
<span class=nb>echo</span> <span class=s2>&quot;&lt;h3&gt;Hello World from </span><span class=k>$(</span>hostname -f<span class=k>)</span><span class=s2> in AZ= </span><span class=nv>$EC2_AZ</span><span class=s2> &lt;/h3&gt;&quot;</span> &gt; /var/www/html/index.html
</code></pre></div> <p>This script can be added as User Data (Under Advanced Details while configuring new instance) so when the instance starts it executes this code.</p> <h3 id=elastic-network-insterfaces>Elastic Network Insterfaces<a class=headerlink href=#elastic-network-insterfaces title="Permanent link">&para;</a></h3> <p>ENI is a logical component in a VPC that represents a virtual network card. It has the following attributes:</p> <ul> <li>One primary private IPv4, one or more secondary IPv4</li> <li>One Elastic IP (IPv4) per private IPv4</li> <li>One Public IPv4</li> <li>One or more security groups</li> <li>A MAC address</li> <li>We can create ENI independently and attach them on the fly (move them) on EC2 instances for failover </li> <li>Bound to a specific availability zone (AZ)</li> </ul> <p><a href=https://aws.amazon.com/blogs/aws/new-elastic-network-interfaces-in-the-virtual-private-cloud/ >New ENI doc.</a></p> <h2 id=placement-groups>Placement groups<a class=headerlink href=#placement-groups title="Permanent link">&para;</a></h2> <p>Define strategy to place EC2 instances:</p> <ul> <li><strong>Cluster</strong>: groups instances into a low-latency group in a single Availability Zone<ul> <li>highest performance while talking to each other as when performing big data analysis</li> </ul> </li> <li><strong>Spread</strong>: groups across underlying hardware (max 7 instances per group per AZ)<ul> <li>Reduced risk is simultaneous failure</li> <li>EC2 Instances are on different physical hardware</li> <li>Application that needs to maximize high availability</li> <li>Critical Applications where each instance must be isolated from failure from each other</li> </ul> </li> <li><strong>Partition</strong>: spreads instances across many different partitions (which rely on different sets of racks) within an AZ.<ul> <li>Partition is a set of racks</li> <li>Up to 100s of EC2 instances</li> <li>The instances in a partition do not share racks with the instances in the other partitions</li> <li>A partition failure can affect many EC2s but won’t affect other partitions</li> <li>EC2 instances get access to the partition information as metadata</li> <li>HDFS, HBase, Cassandra, Kafka</li> </ul> </li> </ul> <p>Access from network and policies menu, define the group with expected strategy, and then it is used when creating the EC2 instance by adding the instance to a placement group.</p> <h2 id=elastic-load-balancer>Elastic Load balancer<a class=headerlink href=#elastic-load-balancer title="Permanent link">&para;</a></h2> <p>Route traffic into the different EC2 instances. Elastic Load Balancing scales your load balancer capacity automatically in response to changes in incoming traffic.</p> <p>It also exposes a single point of access (DNS) to the deployed applications. In case of EC2 failure, it can route to a new instance, transparently and across multiple AZs. It uses health check (/health on the app called the <code>ping path</code>) to assess instance availability. It also provides SSL termination. It supports to separate private (internal) to public (external) traffic.</p> <p><img alt=1 src=images/EC2-AZ.png></p> <p>Need to enable availability zone to be able to route traffic between target groups in different AZs.</p> <p>When you create a load balancer, you must choose whether to make it an internal load balancer or an internet-facing load balancer. Internet-facing load balancer have public IP addresses. The DNS name of an internet-facing load balancer is publicly resolvable to the public IP addresses of the nodes. Internal load balancer have only private IP addresses. Internal load balancers can only route requests from clients with access to the VPC for the load balancer.</p> <p><img alt=2 src=images/elb-scheme.png></p> <p>Four types of ELB supported:</p> <ul> <li><strong>Classic</strong> load balancer: older generation. TCP and HTTP layer. For each instance created, update the load balancer configuration so it can route the traffic.</li> <li> <p><strong>Application load balancer</strong>: HTTP, HTTPS (layer 7), Web Socket. </p> <ul> <li>It specifies availability zones: it routes traffic to the targets in these Availability Zones. Each AZ has one subnet. To increase availability, we need at least two AZs.</li> <li>It uses target groups, to group applications</li> <li>route on URL, hostname and query string</li> <li>Get a fixed hostname</li> <li>the application do not see the IP address of the client directly (ELB does a connection termination), but ELB put it in the header <code>X-Forwarded-For</code>, <code>X-Forwarded-Port</code> and <code>X-Forwarded-Proto</code>.</li> <li>Great for microservices or for container based apps.</li> <li>Free to get started</li> </ul> </li> <li> <p><strong>Gateway LB</strong>: also use target group.</p> </li> <li> <p><strong>Network load balancer</strong>: TCP, UDP (layer 4), TLS</p> <ul> <li>handle millions request/s</li> <li>reach less than 100ms latency while ALB is at 400ms</li> <li>use to get a public static IP address per availability zone</li> <li>Routes each individual TCP connection to a single target for the life of the connection</li> <li>not free</li> </ul> </li> </ul> <p>To route traffic, first the DNS name of the load balancer is resolved. (They are part of the <code>amazaonaws.com</code> domain). 1 to many IP Addresses are sent back to the client. With NLBs, Elastic Load Balancing creates a network interface for each Availability Zone that you enable. Each load balancer node in the Availability Zone uses this network interface to get a static IP address. ELB scales your load balancer and updates the DNS entry. The time to live is set to 60s. </p> <p>To control that only the load balancer is sending traffic to the application, we need to set up an application security group on HTTP, and HTTPS with the source being the security group id of the ELB. LBs can scale but need to engage AWS operational team.</p> <p>HTTP 503 means LB is at capacity or target app is not registered. Verify security group in case of no communication between LB and app.</p> <p>Target group defines protocol to use, health check checking and what applications to reach (instance, IP or lambda). </p> <p>Example of listener rule for an ALB:</p> <p><img alt=3 src=./images/ALB-listener-rules.png></p> <p>ALB and Classic can use <a href=https://www.haproxy.com/blog/http-keep-alive-pipelining-multiplexing-and-connection-pooling/ >HTTP connection multiplexing</a> to keep one connection with the backend application. Connection multiplexing improves latency and reduces the load on your applications.</p> <h3 id=load-balancer-stickiness>Load balancer stickiness<a class=headerlink href=#load-balancer-stickiness title="Permanent link">&para;</a></h3> <p>Used when the same client needs to interact with the same backend instance. A cookie, with expiration date, is used to identify the client. The classical gateway or ALB manages the routing. This could lead to unbalance traffic so overloading one instance. With ALB, stickness is configured in the target group properties.</p> <h3 id=cross-zone-load-balancing>Cross Zone Load Balancing<a class=headerlink href=#cross-zone-load-balancing title="Permanent link">&para;</a></h3> <p>Each load balancer instance distributes traffic evenly across all registered instances in all availability zones. If one AZ has 2 targets and another one has 8 targets, then with cross-zone, the LBs in each availability zone will route to any instance, so each will receive 10% of the traffic. Without that, the 2 targets zone will receive 25% traffic each, and the instance on the othe AZ only 6.25% of the traffic. This is the default setting for ALB and free of charge. It is disabled by default for NLB.</p> <h3 id=tls-transport-layer-security>TLS - Transport Layer Security,<a class=headerlink href=#tls-transport-layer-security title="Permanent link">&para;</a></h3> <p>An SSL/TLS Certificate allows traffic between clients and load balancer to be encrypted in transit (in-flight encryption).</p> <ul> <li>Load balancer uses an X.509 certificate (SSL/TLS server certificate). </li> <li>Manage certificates using ACM (AWS Certificate Manager)</li> <li>When defining a HTTPS listener in a LB, we must specify a default certificate for the HTTPS protocol, while defining the routing rule to a given target group. Need multiple certs to support multiple domains. </li> <li>Clients can use SNI (Server Name Indication) to specify the hostname they reach. The ALB or NLB will get the certificate for this host to support the TLS handshake. </li> </ul> <h3 id=connection-draining>Connection draining<a class=headerlink href=#connection-draining title="Permanent link">&para;</a></h3> <p>This is a setting to control connection timeout and reconnect when an instance is not responding. It is to set up the time to complete “in-flight requests”. When an instance is "draining", ELB stops sending new requests to the instance. The time out can be adjusted, depending of the application, from 1 to 3600 seconds, default is 300 seconds, or disabled (set value to 0).</p> <h3 id=auto-scaling-group-asg>Auto Scaling Group (ASG)<a class=headerlink href=#auto-scaling-group-asg title="Permanent link">&para;</a></h3> <p>The goal of an ASG is to scale out (add EC2 instances) to match an increased load, or scale in (remove EC2 instances) to match a decreased load. It helps to provision and balance capacity across Availability Zones to optimize availability. It can also ensure we have a minimum and a maximum number of machines running. It detects when an instance is unhealthy. </p> <p>Automatically Register new instances to a load balancer.</p> <p><a href="https://us-west-1.console.aws.amazon.com/ec2autoscaling/home?region=us-west-1#/">ASG</a> has the following attributes:</p> <ul> <li>AMI + Instance Type with EC2 User Data (Can use template to define instances)</li> <li>EBS Volumes</li> <li>Security Groups</li> <li>SSH Key Pair</li> <li>Min Size / Max Size / Initial Capacity to control number of instances </li> <li>Network + Subnets Information to specify where to run the EC2 instances.</li> <li>Load Balancer Information, with target groups to be used as a grouping of the newly created instances</li> <li>Scaling Policies help to define rules to manage instance life cycle, based for example on CPU usage or network bandwidth used. </li> </ul> <p><img alt=4 src=images/ASG-1.png></p> <ul> <li>when creating scaling policies, <strong>CloudWatch</strong> alarms are created. Ex: "Create an alarm if: CPUUtilization &lt; 36 for 15 data points within 15 minutes".</li> <li>ASG tries the balance the number of instances across AZ by default, and then delete based on the age of the launch configuration</li> <li>The capacity of our ASG cannot go over the maximum capacity we have allocated during scale out events</li> <li>when an ALB validates an health check issue it terminates the EC2 instance.</li> </ul> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=.. class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Introduction </div> </div> </a> <a href=../gettingstarted/ class="md-footer__link md-footer__link--next" aria-label="Next: Playground" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Playground </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "content.tooltips", "navigation.tabs", "navigation.instant", "navigation.sections", "navigation.expand", "navigation.tabs.sticky", "navigation.top"], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.37e9125f.min.js></script> </body> </html>